---
import PostPage from "../components/PostPage.astro";
import Pagination from "../components/control/Pagination.astro";
import { PAGE_SIZE } from "../constants/constants";
import MainGridLayout from "../layouts/MainGridLayout.astro";
import { getSortedPosts } from "@features/content";
export const prerender = false;

const allBlogPosts = await getSortedPosts();
const total = allBlogPosts.length;
const lastPage = Math.max(1, Math.ceil(total / PAGE_SIZE));
const param = Astro.params.page;
const parsed = param ? Number.parseInt(param) : 1;
const currentPage = Number.isNaN(parsed) ? 1 : parsed;
const safePage = Math.min(Math.max(currentPage, 1), lastPage);

const start = (safePage - 1) * PAGE_SIZE;
const end = Math.min(start + PAGE_SIZE, total);
const data = allBlogPosts.slice(start, end);

const page = {
	data,
	start,
	end,
	size: PAGE_SIZE,
	total,
	currentPage: safePage,
	lastPage,
	url: {
		current: safePage === 1 ? "/" : `/${safePage}/`,
		prev:
			safePage > 1 ? (safePage - 1 === 1 ? "/" : `/${safePage - 1}/`) : undefined,
		next: safePage < lastPage ? `/${safePage + 1}/` : undefined,
	},
};

const len = page.data.length;
---

<MainGridLayout>
    <PostPage page={page}></PostPage>
    <Pagination class="mx-auto onload-animation" page={page} style={`animation-delay: calc(var(--content-delay) + ${(len)*50}ms)`}></Pagination>
</MainGridLayout>