---
import PostPage from "../../components/PostPage.astro";
import Pagination from "../../components/control/Pagination.astro";
import { PAGE_SIZE, SUPPORTED_LANGUAGES, DEFAULT_LANGUAGE } from "../../constants/constants";
import MainGridLayout from "../../layouts/MainGridLayout.astro";
import { getSortedPosts } from "../../utils/content-utils";

export async function getStaticPaths() {
	const paths = [];
	
	for (const lang of SUPPORTED_LANGUAGES) {
		if (lang === DEFAULT_LANGUAGE) continue;
		
		const allBlogPosts = await getSortedPosts(lang);
		const totalPages = Math.max(1, Math.ceil(allBlogPosts.length / PAGE_SIZE));
		
		for (let i = 0; i < totalPages; i++) {
			const pageNum = i + 1;
			paths.push({
				params: { 
					lang,
					page: pageNum === 1 ? undefined : pageNum.toString() 
				},
				props: { currentPage: pageNum, lang },
			});
		}
	}
	
	return paths;
}

const { currentPage, lang } = Astro.props;
const allBlogPosts = await getSortedPosts(lang);
const total = allBlogPosts.length;
const lastPage = Math.max(1, Math.ceil(total / PAGE_SIZE));
const safePage = Math.min(Math.max(currentPage, 1), lastPage);

const start = (safePage - 1) * PAGE_SIZE;
const end = Math.min(start + PAGE_SIZE, total);
const data = allBlogPosts.slice(start, end);

const page = {
	data,
	start,
	end,
	size: PAGE_SIZE,
	total,
	currentPage: safePage,
	lastPage,
	url: {
		current: safePage === 1 ? `/${lang}/` : `/${lang}/${safePage}/`,
		prev:
			safePage > 1 ? (safePage - 1 === 1 ? `/${lang}/` : `/${lang}/${safePage - 1}/`) : undefined,
		next: safePage < lastPage ? `/${lang}/${safePage + 1}/` : undefined,
		first: `/${lang}/`,
		last: lastPage === 1 ? "/" : `/${lastPage}/`,
	},
};

const len = page.data.length;
---

<MainGridLayout lang={lang}>
    <PostPage page={page} lang={lang}></PostPage>
    <Pagination class="mx-auto onload-animation" page={page} style={`animation-delay: calc(var(--content-delay) + ${(len)*50}ms)`}></Pagination>
</MainGridLayout>
