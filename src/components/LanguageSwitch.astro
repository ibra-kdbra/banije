---
import { Icon } from "astro-icon/components";

const languages = [
	{ value: "en", label: "EN" },
	{ value: "es", label: "ES" },
	{ value: "ja", label: "JA" },
	{ value: "ko", label: "KO" },
	{ value: "tr", label: "TR" },
	{ value: "zh_CN", label: "简体" },
	{ value: "zh_TW", label: "繁體" },
];

const currentLang = Astro.cookies.get("lang")?.value || "en";
const currentLabel = languages.find((l) => l.value === currentLang)?.label || "EN";
---

<div class="relative group">
	<button
		id="lang-switch-btn"
		aria-label="Change Language"
		aria-haspopup="true"
		aria-expanded="false"
		class="btn-plain scale-animation rounded-lg h-11 min-w-[4.5rem] px-3 font-bold text-sm flex items-center justify-between gap-1
			bg-black/[0.04] hover:bg-black/[0.06] dark:bg-white/5 dark:hover:bg-white/10
			text-black/75 dark:text-white/75 transition-colors"
	>
		<span class="whitespace-nowrap">{currentLabel}</span>
		<Icon name="material-symbols:expand-more-rounded" class="text-[1.25rem] opacity-75" />
	</button>

	<div
		id="lang-dropdown"
		class="absolute right-0 top-12 min-w-[8rem] p-1.5 rounded-xl border border-black/5 dark:border-white/5
			bg-[var(--float-panel-bg)] shadow-xl invisible opacity-0 translate-y-2
			transition-all duration-200 z-50 origin-top-right backdrop-blur-md"
	>
		{languages.map((lang) => (
			<button
				onclick={`changeLang('${lang.value}')`}
				class={`w-full text-left px-3 py-2 my-0.5 rounded-lg text-sm font-medium transition-colors
					${currentLang === lang.value 
						? 'bg-[var(--primary)] text-white' 
						: 'hover:bg-[var(--btn-plain-bg-hover)] active:bg-[var(--btn-plain-bg-active)] text-black/75 dark:text-white/75'}`}
			>
				{lang.label}
			</button>
		))}
	</div>
</div>

<script is:inline>
	const btn = document.getElementById("lang-switch-btn");
	const dropdown = document.getElementById("lang-dropdown");
	let isOpen = false;

	function toggleDropdown() {
		isOpen = !isOpen;
		if (isOpen) {
			dropdown?.classList.remove("invisible", "opacity-0", "translate-y-2");
			btn?.setAttribute("aria-expanded", "true");
		} else {
			dropdown?.classList.add("invisible", "opacity-0", "translate-y-2");
			btn?.setAttribute("aria-expanded", "false");
		}
	}

	btn?.addEventListener("click", (e) => {
		e.stopPropagation();
		toggleDropdown();
	});

	document.addEventListener("click", () => {
		if (isOpen) toggleDropdown();
	});

	dropdown?.addEventListener("click", (e) => {
		e.stopPropagation();
	});

	window.changeLang = (lang) => {
		document.cookie = `lang=${lang}; path=/; max-age=31536000`;
		window.location.reload();
	};
</script>
